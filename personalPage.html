<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>개인 소개 페이지</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        updateDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBPMReE-tcQ6Bx43oSoizq725rrdQ9Fx9E",
        authDomain: "sparta-87f88.firebaseapp.com",
        projectId: "sparta-87f88",
        storageBucket: "sparta-87f88.appspot.com",
        messagingSenderId: "296182026935",
        appId: "1:296182026935:web:f6d094e79ed39d815fb332",
        measurementId: "G-C7C8MHE9R1",
      };

      // Firebase 인스턴스 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get("memberId");
        const dbRef = doc(db, "members", memberId);

        async function fetchAndRenderMemberData() {
          const docSnap = await getDoc(dbRef);
          if (docSnap.exists()) {
            const memberData = docSnap.data();

            // 기본 정보 및 이미지 렌더링
            document.getElementById("name").textContent = memberData.name;
            document.getElementById("profilePic").src =
              memberData.image || "path/to/default/image.png";

            // 추가 정보 렌더링
            document.getElementById("displayAge").textContent =
              memberData.age || "";
            document.getElementById("displayLocation").textContent =
              memberData.location || "";
            document.getElementById("displayMbti").textContent =
              memberData.mbti || "";
            document.getElementById("displaySkills").textContent =
              memberData.skills || "";
            document.getElementById("displayDevType").textContent =
              memberData.devType || "";
            document.getElementById("displayMessage").textContent =
              memberData.message || "";

            // Edit form에도 데이터 세팅
            document.getElementById("imageUploadUrl").value =
              memberData.image || "";
            document.getElementById("ageInput").value = memberData.age || "";
            document.getElementById("locationInput").value =
              memberData.location || "";
            document.getElementById("mbtiInput").value = memberData.mbti || "";
            document.getElementById("skillsInput").value =
              memberData.skills || "";
            document.getElementById("devTypeInput").value =
              memberData.devType || "";
            document.getElementById("messageInput").value =
              memberData.message || "";
          } else {
            console.log("No such document!");
          }
        }

        document
          .getElementById("editProfileBtn")
          .addEventListener("click", function () {
            document.getElementById("editForm").style.display = "block";
            document.getElementById("profile-info").style.display = "none";
          });

        document
          .getElementById("saveProfileBtn")
          .addEventListener("click", async function () {
            const image = document.getElementById("imageUploadUrl").value;
            const age = document.getElementById("ageInput").value;
            const location = document.getElementById("locationInput").value;
            const mbti = document.getElementById("mbtiInput").value;
            const skills = document.getElementById("skillsInput").value;
            const devType = document.getElementById("devTypeInput").value;
            const message = document.getElementById("messageInput").value;

            const updatedData = {
              image,
              age,
              location,
              mbti,
              skills,
              devType,
              message,
            };
            await updateDoc(dbRef, updatedData);

            // 업데이트 후 정보 다시 불러와서 화면에 표시 (새로고침 없이)
            fetchAndRenderMemberData();
            document.getElementById("editForm").style.display = "none";
            document.getElementById("profile-info").style.display = "block";
          });
        document
          .getElementById("deleteProfileBtn")
          .addEventListener("click", async function () {
            if (confirm("해당 멤버 정보를 삭제 하시겠습니까?")) {
              await deleteDoc(dbRef);
              alert("해당 멤버가 삭제 되었습니다.");
              window.location.href = "index.html";
            }
          });

        fetchAndRenderMemberData();
      });

      fetch("navbar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("navbar").innerHTML = data;
          // 네비게이션 바가 로드되고 난 후 실행할 스크립트
          const script1 = document.createElement("script");
          script1.src = "Js/navbar/dday.js";
          document.body.appendChild(script1);

          const script2 = document.createElement("script");
          script2.src = "Js/navbar/weather.js";
          document.body.appendChild(script2);

          const script3 = document.createElement("script");
          script3.src = "Js/navbar/theme.js";
          document.body.appendChild(script3);
        });
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="Css/theme.css" />
    <link rel="stylesheet" href="Css/personalPage.css" />
  </head>
  <body class="whiteTheme">
    <div id="navbar"></div>
    <div class="mainContainer">
      <hr class="featurette-divider" />
      <div class="main">
        <div class="profile">
          <div class="left-profile">
            <span id="name"></span>
            <div class="profile-picture">
              <img
                id="profilePic"
                src="data:image/jpeg;base64,..."
                style="width: 300px; height: 300px"
              />
            </div>
          </div>
          <div id="profile-info" class="profile-info">
            <div id="infoDisplay">
              <p>나이 : <span id="displayAge"></span></p>
              <p>사는 곳 : <span id="displayLocation"></span></p>
              <p>MBTI : <span id="displayMbti"></span></p>
              <p>기술 스택 : <span id="displaySkills"></span></p>
              <p>되고자 하는 개발자 : <span id="displayDevType"></span></p>
              <p>하고 싶은 말 : <span id="displayMessage"></span></p>
              <div>
                <button
                  type="button"
                  id="editProfileBtn"
                  class="btn btn-outline-secondary"
                >
                  수정하기
                </button>
                <button
                  id="deleteProfileBtn"
                  type="button"
                  class="btn btn-outline-danger"
                >
                  삭제하기
                </button>
              </div>
            </div>
          </div>

          <div id="editForm" style="display: none">
            <input type="text" id="imageUploadUrl" placeholder="이미지 주소" />
            <!-- 이미지 URL이 길 수 있으므로 제한을 200자로 설정 -->
            <input
              type="number"
              id="ageInput"
              placeholder="나이"
              maxlength="10"
            />
            <input
              type="text"
              id="locationInput"
              placeholder="사는 곳"
              maxlength="10"
            />
            <input
              type="text"
              id="mbtiInput"
              placeholder="MBTI"
              maxlength="10"
            />
            <input
              type="text"
              id="skillsInput"
              placeholder="기술 스택"
              maxlength="20"
            />
            <input
              type="text"
              id="devTypeInput"
              placeholder="되고자 하는 개발자"
              maxlength="20"
            />
            <textarea
              id="messageInput"
              placeholder="하고 싶은 말"
              maxlength="20"
            ></textarea>
            <button
              id="saveProfileBtn"
              type="button"
              class="btn btn-outline-primary"
            >
              저장하기
            </button>
          </div>
        </div>
      </div>
      <hr class="featurette-divider" />
    </div>
  </body>
</html>
