<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê°œì¸ ì†Œê°œ í˜ì´ì§€</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/personalPage.css" />
    <link rel="stylesheet" href="css/navbar.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    User
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        updateDoc,
        deleteDoc,
        collection,
        addDoc,
        query,
        orderBy,
        getDocs,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import { increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAfN5PZcj9NbBj2vdB8JMFQp_zTAm-xHuk",
        authDomain: "js-miniproject.firebaseapp.com",
        projectId: "js-miniproject",
        storageBucket: "js-miniproject.appspot.com",
        messagingSenderId: "682214502456",
        appId: "1:682214502456:web:686883842015c32e59f6cd",
        measurementId: "G-G9NFH0GQ2E",
      };
      // Firebase ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get("memberId");
        const dbRef = doc(db, "members", memberId);

        async function fetchAndRenderMemberData() {
          const docSnap = await getDoc(dbRef);
          if (docSnap.exists()) {
            const memberData = docSnap.data();

            // ê¸°ë³¸ ì •ë³´ ë° ì´ë¯¸ì§€ ë Œë”ë§
            document.title = `${memberData.name} í˜ì´ì§€`;
            document.getElementById("name").textContent = memberData.name;
            document.getElementById("profilePic").src =
              memberData.image || "path/to/default/image.png";

            // ì¶”ê°€ ì •ë³´ ë Œë”ë§
            document.getElementById("displayAge").textContent =
              memberData.age || "";
            document.getElementById("displayLocation").textContent =
              memberData.location || "";
            document.getElementById("displayMbti").textContent =
              memberData.mbti || "";
            document.getElementById("displaySpecialty").textContent =
              memberData.specialty || "";
            document.getElementById("displayFavoriteFood").textContent =
              memberData.favoriteFood || "";

            // Edit formì—ë„ ë°ì´í„° ì„¸íŒ…
            document.getElementById("imageUploadUrl").value =
              memberData.image || "";
            document.getElementById("ageInput").value = memberData.age || "";
            document.getElementById("locationInput").value =
              memberData.location || "";
            document.getElementById("mbtiInput").value = memberData.mbti || "";
            document.getElementById("specialtyInput").value =
              memberData.specialty || "";
            document.getElementById("favoriteFoodInput").value =
              memberData.favoriteFood || "";
          } else {
            console.log("No such document!");
          }
        }

        document
          .getElementById("editProfileBtn")
          .addEventListener("click", function () {
            document.getElementById("editForm").style.display = "block";
            document.getElementById("profile-info").style.display = "none";
          });

        document
          .getElementById("saveProfileBtn")
          .addEventListener("click", async function () {
            const image = document.getElementById("imageUploadUrl").value;
            const age = document.getElementById("ageInput").value;
            const location = document.getElementById("locationInput").value;
            const mbti = document
              .getElementById("mbtiInput")
              .value.toUpperCase(); // MBTIëŠ” ëŒ€ë¬¸ìë¡œ ë³€í™˜
            const specialty = document.getElementById("specialtyInput").value;
            const favoriteFood =
              document.getElementById("favoriteFoodInput").value;

            // ë‚˜ì´: ìˆ«ìë§Œ í—ˆìš©, ê¸¸ì´ ì œí•œ 3ì
            if (!/^\d+$/.test(age) || age.length > 3) {
              alert("ë‚˜ì´ëŠ” ìˆ«ìë§Œ 3ìë¦¬ ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            // ì‚¬ëŠ” ê³³: ê¸¸ì´ ì œí•œ 20ì
            if (location.length > 20) {
              alert("ì‚¬ëŠ” ê³³ì€ 20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            // MBTI: ê¸¸ì´ ì œí•œ 4ì, ìœ íš¨í•œ MBTI ìœ í˜• ê²€ì‚¬
            const validMbtiTypes = [
              "ISTJ",
              "ISFJ",
              "INFJ",
              "INTJ",
              "ISTP",
              "ISFP",
              "INFP",
              "INTP",
              "ESTP",
              "ESFP",
              "ENFP",
              "ENTP",
              "ESTJ",
              "ESFJ",
              "ENFJ",
              "ENTJ",
            ];
            if (!validMbtiTypes.includes(mbti)) {
              alert("ìœ íš¨í•œ MBTI ìœ í˜•ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: INFP, ESTJ)");
              return;
            }

            // íŠ¹ê¸°: ê¸¸ì´ ì œí•œ 20ì
            if (specialty.length > 20) {
              alert("íŠ¹ê¸°ëŠ” 20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            // ìµœì•  ìŒì‹: ê¸¸ì´ ì œí•œ 20ì
            if (favoriteFood.length > 20) {
              alert("ìµœì•  ìŒì‹ì€ 20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            // ëª¨ë“  ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•œ ê²½ìš°, ë°ì´í„° ì—…ë°ì´íŠ¸
            const updatedData = {
              image,
              age,
              location,
              mbti,
              specialty,
              favoriteFood,
            };
            try {
              await updateDoc(dbRef, updatedData);
              alert("ì •ë³´ê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.");
              fetchAndRenderMemberData(); // ì—…ë°ì´íŠ¸ í›„ ì •ë³´ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ í™”ë©´ì— í‘œì‹œ
              document.getElementById("editForm").style.display = "none";
              document.getElementById("profile-info").style.display = "block";
            } catch (error) {
              console.error("ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
              alert("ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        document
          .getElementById("deleteProfileBtn")
          .addEventListener("click", async function () {
            if (confirm("í•´ë‹¹ ë©¤ë²„ ì •ë³´ë¥¼ ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              await deleteDoc(dbRef);
              alert("í•´ë‹¹ ë©¤ë²„ê°€ ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
              window.location.href = "index.html";
            }
          });

        $("#submitGuestbook").click(async function () {
          let name = $("#guestName").val().trim(); // ì•ë’¤ ê³µë°± ì œê±°
          let message = $("#guestMessage").val().trim(); // ì•ë’¤ ê³µë°± ì œê±°

          // ì‘ì„±ì ì´ë¦„ ëˆ„ë½ ì…ë ¥ ê²€ì‚¬
          if (name === "") {
            alert("ì‘ì„±ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return; // í•¨ìˆ˜ ì‹¤í–‰ ì¢…ë£Œ
          }

          // ì‘ì„±ì ì´ë¦„ ê¸¸ì´ ê²€ì‚¬
          if (name.length > 10) {
            alert("ì‘ì„±ì ì´ë¦„ì€ 10ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return; // í•¨ìˆ˜ ì‹¤í–‰ ì¢…ë£Œ
          }

          if (message === "") {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return; // í•¨ìˆ˜ ì‹¤í–‰ ì¢…ë£Œ
          }

          // ë‚´ìš© ê¸¸ì´ ê²€ì‚¬
          if (message.length > 50) {
            alert("ë‚´ìš©ì€ 50ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return; // í•¨ìˆ˜ ì‹¤í–‰ ì¢…ë£Œ
          }

          // ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•œ ê²½ìš°, ë°©ëª…ë¡ì— ë°ì´í„° ì¶”ê°€
          try {
            const docRef = await addDoc(
              collection(db, "members", memberId, "guestbook"),
              {
                name,
                message,
                timestamp: serverTimestamp(),
                likes: 0,
              }
            );
            alert("ì‘ì„± ì™„ë£Œ.");
            $("#guestName").val(""); // ì‘ì„±ì ì´ë¦„ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            $("#guestMessage").val(""); // ë©”ì‹œì§€ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”

            renderGuestbookEntries(); // ë°©ëª…ë¡ ë‹¤ì‹œ ë Œë”ë§
          } catch (error) {
            console.error("ë°©ëª…ë¡ ì‘ì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ë°©ëª…ë¡ì„ ì‘ì„±í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        });

        async function renderGuestbookEntries() {
          const guestbookRef = collection(db, "members", memberId, "guestbook");
          const q = query(guestbookRef, orderBy("timestamp", "desc"));
          const querySnapshot = await getDocs(q);
          $("#guestbookEntries").empty();

          querySnapshot.forEach((doc) => {
            const entry = doc.data();
            const timestamp = entry.timestamp
              ? new Date(entry.timestamp.toDate())
              : new Date();

            const formattedDate = timestamp.toLocaleString();
            const entryElement = `
                  <div class="guestbook-entry">
                    <span class="guestbook-name">${entry.name}:</span>
                    <p class="guestbook-message">${entry.message}</p>
                    <span class="guestbook-timestamp">${formattedDate}</span>
                    <button class="btn btn-primary like-button" data-id="${
                      doc.id
                    }">ğŸ‘</button>
                    <span class="likes-count"> ${entry.likes || 0}</span>
                    
                    <button class="btn btn-danger delete-guestbook-entry" data-id="${
                      doc.id
                    }">âŒ</button>
                  </div>
                  `;
            $("#guestbookEntries").append(entryElement);
          });

          // 'ì¢‹ì•„ìš”' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          $(".like-button").click(async function () {
            const docId = $(this).data("id");
            const guestbookDocRef = doc(
              db,
              "members",
              memberId,
              "guestbook",
              docId
            );
            await updateDoc(guestbookDocRef, { likes: increment(1) });
            renderGuestbookEntries(); // 'ì¢‹ì•„ìš”' ìˆ˜ ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ ë Œë”ë§
          });

          // 'ì‚­ì œ' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          $(".delete-guestbook-entry").click(async function () {
            const docId = $(this).data("id");
            await deleteDoc(doc(db, "members", memberId, "guestbook", docId));
            renderGuestbookEntries(); // ì‚­ì œ í›„ ë‹¤ì‹œ ë Œë”ë§
          });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°©ëª…ë¡ ë Œë”ë§
        $(document).ready(function () {
          renderGuestbookEntries();
        });

        fetchAndRenderMemberData();
      });
    </script>
  </head>
  <body>
    <div class="navbar">
      <div class="left-container">
        <div id="weather"><span></span><span></span></div>
        <div class="countdown">
          <span>ë¶€íŠ¸ìº í”„ ì¢…ë£Œ :</span>
          <span id="countdown"></span>
        </div>
      </div>
      <div class="title-container">
        <h1 class="title"><img src="img/logo.png" / width="300px"></h1>
      </div>
      <div class="right-container">
        <div class="home">
          <a href="index.html">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="30"
              height="30"
              fill="currentColor"
              class="bi bi-house-door-fill"
              viewBox="0 0 16 16"
            >
              <path
                d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.5v3.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5"
              />
            </svg>
          </a>
        </div>

        <div class="theme-switch">
          <!-- í…Œë§ˆ í† ê¸€ ë²„íŠ¼ -->
          <button
            class="theme-btn light"
            onclick="changeTheme('light')"
            title="Light mode"
          >
            <img src="https://assets.codepen.io/210284/sun.png" alt="sun" />
          </button>
          <button
            class="theme-btn dark"
            onclick="changeTheme('dark')"
            title="Dark mode"
          >
            <img src="https://assets.codepen.io/210284/moon.png" alt="moon" />
          </button>
        </div>
      </div>
    </div>
    <div class="mainContainer">
      <
      <div class="mainContainer">
        <hr class="featurette-divider" />
        <div class="main">
          <div class="profile">
            <div class="left-profile">
              <span id="name"></span>
              <div class="profile-picture">
                <img
                  id="profilePic"
                  src="data:image/jpeg;base64,..."
                  style="width: 300px; height: 300px"
                />
              </div>
            </div>
            <div id="profile-info" class="profile-info">
              <div id="infoDisplay">
                <p>ë‚˜ì´ : <span id="displayAge"></span></p>
                <p>ì‚¬ëŠ” ê³³ : <span id="displayLocation"></span></p>
                <p>MBTI : <span id="displayMbti"></span></p>
                <p>íŠ¹ê¸° : <span id="displaySpecialty"></span></p>
                <p>ìµœì•  ìŒì‹ : <span id="displayFavoriteFood"></span></p>
                <div>
                  <button
                    type="button"
                    id="editProfileBtn"
                    class="btn btn-outline-secondary"
                  >
                    ìˆ˜ì •í•˜ê¸°
                  </button>
                  <button
                    id="deleteProfileBtn"
                    type="button"
                    class="btn btn-outline-danger"
                  >
                    ì‚­ì œí•˜ê¸°
                  </button>
                </div>
              </div>
            </div>

            <div id="editForm" style="display: none">
              <input
                type="text"
                id="imageUploadUrl"
                placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ"
              />
              <!-- ì´ë¯¸ì§€ URLì´ ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì œí•œì„ 200ìë¡œ ì„¤ì • -->
              <input
                type="number"
                id="ageInput"
                placeholder="ë‚˜ì´"
                maxlength="3"
              />
              <input
                type="text"
                id="locationInput"
                placeholder="ì‚¬ëŠ” ê³³"
                maxlength="20"
              />
              <input
                type="text"
                id="mbtiInput"
                placeholder="MBTI"
                maxlength="4"
              />
              <input
                type="text"
                id="specialtyInput"
                placeholder="íŠ¹ê¸°"
                maxlength="20"
              />

              <input
                type="text"
                id="favoriteFoodInput"
                placeholder="ìµœì•  ìŒì‹"
                maxlength="20"
              />
              <button
                id="saveProfileBtn"
                type="button"
                class="btn btn-outline-primary"
              >
                ì €ì¥í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
        <hr class="featurette-divider" />
        <div class="guestbook-container">
          <div class="guestbook-posts">
            <div id="guestbookEntries"></div>
          </div>
          <hr class="featurette-divider" />
          <div class="guestbook-write">
            <input
              type="text"
              id="guestName"
              placeholder="ì‘ì„±ì"
              maxlength="10"
            />
            <textarea
              id="guestMessage"
              placeholder="ë°©ëª…ë¡ ë‚´ìš©"
              maxlength="50"
            ></textarea>
            <button id="submitGuestbook" class="btn btn-primary">
              ì‘ì„±í•˜ê¸°
            </button>
          </div>
          <hr class="featurette-divider" />
        </div>
      </div>
    </div>

    <script src="js/theme.js"></script>
    <script src="js/weather.js"></script>
    <script src="js/scroll.js"></script>
    <script src="js/dday.js"></script>
  </body>
</html>
